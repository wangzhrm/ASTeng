<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>AST Admin - Link Manager</title>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    <style>
        :root { --primary: #2c3e50; --accent: #3498db; --success: #27ae60; --bg: #f8f9fa; }
        body { font-family: 'Segoe UI', sans-serif; display: flex; height: 100vh; margin: 0; background: var(--bg); overflow: hidden; }
        
        /* Sidebar */
        #sidebar { width: 400px; min-width: 320px; background: white; padding: 20px; border-right: 1px solid #dee2e6; overflow-y: auto; height: 100vh; box-sizing: border-box; }
        #resizer { width: 10px; cursor: col-resize; background: #eee; display: flex; align-items: center; justify-content: center; }
        #resizer:hover { background: var(--accent); }

        /* Main Workspace */
        #editor-zone { flex-grow: 1; padding: 30px; display: flex; flex-direction: column; gap: 20px; overflow: hidden; position: relative; }
        .card { background: #fff; padding: 20px; border-radius: 10px; border: 1px solid #e9ecef; box-shadow: 0 2px 4px rgba(0,0,0,0.02); }
        h3 { margin: 0 0 10px 0; font-size: 11px; color: #adb5bd; text-transform: uppercase; letter-spacing: 1.5px; }
        
        select, input, textarea { width: 100%; padding: 10px; margin: 5px 0; border: 1px solid #ced4da; border-radius: 6px; box-sizing: border-box; font-size: 14px; }
        button { cursor: pointer; padding: 10px; border: none; border-radius: 6px; font-weight: bold; width: 100%; transition: 0.2s; }
        .btn-add { background: var(--success); color: white; margin-top: 5px; }
        .btn-primary { background: var(--accent); color: white; }
        
        /* Preview Box */
        #display-box { background: white; border: 1px solid #dee2e6; border-radius: 8px; padding: 30px; flex-grow: 1; overflow-y: auto; white-space: pre-wrap; font-family: 'Georgia', serif; line-height: 1.8; font-size: 1.15em; color: #2c3e50; }

        /* Floating Button */
        #floating-create-btn { 
            position: absolute; display: none; background: #e67e22; color: white; 
            padding: 8px 15px; border-radius: 20px; font-size: 12px; z-index: 100; 
            box-shadow: 0 4px 10px rgba(0,0,0,0.2); width: auto; 
        }

        /* Saved Links Section */
        #link-list { background: #f1f3f5; padding: 15px; border-radius: 8px; max-height: 200px; overflow-y: auto; border: 1px inset #eee; }
        .link-item { background: white; padding: 10px; border-radius: 6px; margin-bottom: 8px; display: flex; justify-content: space-between; align-items: center; border: 1px solid #e9ecef; }
        .link-info { font-size: 13px; flex-grow: 1; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
        .link-info a { color: var(--accent); text-decoration: none; font-weight: bold; }
        .btn-del-link { background: #ff4757; color: white; padding: 5px 10px; width: auto; font-size: 10px; margin-left: 10px; }
    </style>
</head>
<body>

<div id="sidebar">
    <h2 style="margin-top:0; color:var(--primary); font-size: 22px;">AST Admin</h2>
    
    <div class="card">
        <h3>1. Tier 1: Manage Tests</h3>
        <input type="text" id="new-test-code" placeholder="New Test Name (e.g., Test 1)">
        <button class="btn-add" onclick="addTest()">Create Test</button>
    </div>

    <div class="card">
        <h3>2. Tier 2: Manage Texts</h3>
        <label style="font-size:11px">Select Parent Test First:</label>
        <select id="struct-test-select" onchange="toggleTier2()"></select>
        <input type="text" id="new-text-code" placeholder="New Text Name (e.g., Text 1)" disabled>
        <button id="add-text-btn" class="btn-add" onclick="addText()" disabled>Add Text to Test</button>
    </div>

    <div class="card">
        <h3>3. Passage Editor</h3>
        <select id="main-test-select" onchange="syncTexts()"></select>
        <select id="main-text-select" onchange="loadPassage()"></select>
        <textarea id="passage-input" rows="6" placeholder="Paste passage text here..."></textarea>
        <button class="btn-primary" onclick="savePassage()">Save Content</button>
    </div>
</div>

<div id="resizer"></div>

<div id="editor-zone">
    <button id="floating-create-btn" onclick="saveHighlightedLink()">Create Link for Selection</button>
    <div id="display-box" onmouseup="handleSelection()">Select a Test and Text to begin. Highlight text here to create a link.</div>
    
    <div class="card" style="margin-bottom: 0;">
        <h3>4. Saved Links for this Passage</h3>
        <div id="link-list">
            <div style="color:#999; font-size: 12px; text-align: center; padding: 10px;">No links found.</div>
        </div>
    </div>
</div>

<script>
    const firebaseConfig = {
        apiKey: "AIzaSyDQP8wkV6Hu314ajhwcWGfyD8PIeeUh7Zo",
        authDomain: "ast-eng.firebaseapp.com",
        projectId: "ast-eng",
        storageBucket: "ast-eng.firebasestorage.app",
        messagingSenderId: "476969710355",
        appId: "1:476969710355:web:d993d06afb8873fbc220e6"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    let currentSelection = null;

    // --- SELECTION LOGIC ---
    function handleSelection(e) {
        const sel = window.getSelection();
        const text = sel.toString().trim();
        const btn = document.getElementById('floating-create-btn');

        if (text.length > 0) {
            const range = sel.getRangeAt(0);
            const rect = range.getBoundingClientRect();
            
            currentSelection = { snippet: text, range: range.cloneRange() };

            btn.style.display = 'block';
            btn.style.top = (rect.top + window.scrollY - 45) + 'px';
            btn.style.left = (rect.left + window.scrollX) + 'px';
        } else {
            btn.style.display = 'none';
        }
    }

    async function saveHighlightedLink() {
        const test = document.getElementById('main-test-select').value;
        const text = document.getElementById('main-text-select').value;
        if (!currentSelection || !test || !text) return;

        const displayBox = document.getElementById('display-box');
        const preRange = currentSelection.range.cloneRange();
        preRange.selectNodeContents(displayBox);
        preRange.setEnd(currentSelection.range.startContainer, currentSelection.range.startOffset);
        
        const start = preRange.toString().length;
        const end = start + currentSelection.snippet.length;
        const passageId = `${test}_${text}`;
        const url = `http://wangzhrm.github.io/ASTeng/highlight?id=${passageId}&s=${start}&e=${end}`;

        await db.collection('links').add({
            passageId: passageId,
            snippet: currentSelection.snippet.substring(0, 40),
            url: url,
            created: Date.now()
        });

        document.getElementById('floating-create-btn').style.display = 'none';
        window.getSelection().removeAllRanges();
    }

    // --- DATA LOADING ---
    function loadPassage() {
        const test = document.getElementById('main-test-select').value;
        const text = document.getElementById('main-text-select').value;
        if(!test || !text) return;

        const pId = `${test}_${text}`;
        db.collection('passages').doc(pId).get().then(doc => {
            document.getElementById('display-box').innerText = doc.exists ? doc.data().content : "No content.";
        });

        // Fetch links and sort manually to avoid Indexing errors
        db.collection('links').where('passageId', '==', pId).onSnapshot(snap => {
            const list = document.getElementById('link-list');
            if(snap.empty) { list.innerHTML = '<div style="color:#999; text-align:center;">No links saved.</div>'; return; }
            
            let docs = [];
            snap.forEach(doc => docs.push({id: doc.id, ...doc.data()}));
            docs.sort((a, b) => b.created - a.created); // Newest first

            list.innerHTML = '';
            docs.forEach(d => {
                list.innerHTML += `
                    <div class="link-item">
                        <div class="link-info"><a href="${d.url}" target="_blank">"${d.snippet}..."</a></div>
                        <button class="btn-del-link" onclick="deleteLink('${d.id}')">Delete</button>
                    </div>`;
            });
        });
    }

    function deleteLink(id) { if(confirm("Delete this link?")) db.collection('links').doc(id).delete(); }

    // --- STRUCTURAL BOILERPLATE ---
    function toggleTier2() {
        const v = document.getElementById('struct-test-select').value;
        document.getElementById('new-text-code').disabled = !v;
        document.getElementById('add-text-btn').disabled = !v;
    }
    function addTest() { 
        const n = document.getElementById('new-test-code').value.trim();
        if(n) db.collection('structure').doc(n).set({created: Date.now()}); 
    }
    function addText() {
        const t = document.getElementById('struct-test-select').value;
        const n = document.getElementById('new-text-code').value.trim();
        if(t && n) db.collection('structure').doc(t).collection('texts').doc(n).set({name: n});
    }
    db.collection('structure').onSnapshot(snap => {
        const s1 = document.getElementById('struct-test-select'), s2 = document.getElementById('main-test-select');
        let h = '<option value="">-- Choose Test --</option>';
        snap.forEach(doc => h += `<option value="${doc.id}">${doc.id}</option>`);
        s1.innerHTML = h; s2.innerHTML = h;
    });
    function syncTexts() {
        const t = document.getElementById('main-test-select').value;
        const s = document.getElementById('main-text-select');
        db.collection('structure').doc(t).collection('texts').onSnapshot(snap => {
            s.innerHTML = '<option value="">-- Choose Text --</option>';
            snap.forEach(doc => s.innerHTML += `<option value="${doc.id}">${doc.id}</option>`);
        });
    }
    function savePassage() {
        const t = document.getElementById('main-test-select').value, x = document.getElementById('main-text-select').value, c = document.getElementById('passage-input').value;
        if(t && x) db.collection('passages').doc(`${t}_${x}`).set({test:t, text:x, content:c}).then(()=>alert("Saved!"));
    }

    // --- RESIZER ---
    const sb = document.getElementById('sidebar'), rz = document.getElementById('resizer');
    let m_pos;
    rz.addEventListener("mousedown", (e) => { m_pos = e.x; document.addEventListener("mousemove", resize); });
    document.addEventListener("mouseup", () => document.removeEventListener("mousemove", resize));
    function resize(e){ const dx = m_pos - e.x; m_pos = e.x; sb.style.width = (parseInt(getComputedStyle(sb, '').width) - dx) + "px"; }
</script>
</body>
</html>
